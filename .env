cd /opt/app/wordpress-astro

# 1) Удаляем битый .env
rm -f .env

# 2) Подставим публичный IP
PUBLIC_IP=$(curl -s http://checkip.amazonaws.com | tr -d '\n')

# 3) Создаём .env — ТОЛЬКО пары KEY=VALUE
{
  echo "MYSQL_DATABASE=wordpress"
  echo "MYSQL_USER=wp"
  echo "MYSQL_PASSWORD=super-strong-pass"
  echo "MYSQL_ROOT_PASSWORD=super-root-pass"

  echo "WP_HOME=http://${PUBLIC_IP}:8080"
  echo "WP_SITEURL=http://${PUBLIC_IP}:8080"
  echo "WP_CORS_ALLOWED_ORIGIN=http://${PUBLIC_IP}:4321"

  echo "WP_ADMIN_USER=admin"
  echo "WP_ADMIN_PASSWORD=another-strong-pass"
  echo "WP_ADMIN_EMAIL=you@example.com"

  echo "PUBLIC_WP_API_BASE=http://${PUBLIC_IP}:8080/wp-json"
  echo "WP_API_INTERNAL_BASE=http://wordpress/wp-json"
} > .env

# 4) Проверяем, что внутри только KEY=VALUE
cat -n .env

# 5) Стартуем
docker compose up -d --build
docker compose logs -f --tail=100 wp-cli
