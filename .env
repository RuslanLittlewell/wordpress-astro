# 1) Посмотреть, что сейчас в .env (чисто для контроля)
sed -n '1,80p' .env || true

# 2) Удалить битый .env
rm -f .env

# 3) Подставим публичный IP автоматически
export PUBLIC_IP=$(curl -s http://checkip.amazonaws.com | tr -d '\n')

# 4) Создадим корректный .env (ТОЛЬКО пары KEY=VALUE, никаких команд!)
cat > .env <<EOF
# DB
MYSQL_DATABASE=wordpress
MYSQL_USER=wp
MYSQL_PASSWORD=super-strong-pass
MYSQL_ROOT_PASSWORD=super-root-pass

# WordPress URL (пока на IP:8080)
WP_HOME=http://${PUBLIC_IP}:8080
WP_SITEURL=http://${PUBLIC_IP}:8080

# CORS: откуда будет обращаться фронтенд (dev-порт 4321)
WP_CORS_ALLOWED_ORIGIN=http://${PUBLIC_IP}:4321

# WP админ
WP_ADMIN_USER=admin
WP_ADMIN_PASSWORD=another-strong-pass
WP_ADMIN_EMAIL=you@example.com

# API для фронта (Astro)
PUBLIC_WP_API_BASE=http://${PUBLIC_IP}:8080/wp-json

# Внутренний адрес API для контейнеров
WP_API_INTERNAL_BASE=http://wordpress/wp-json
EOF

# 5) Быстрая проверка формата: должны быть только KEY=VALUE
awk 'NF && $0 !~ /^#/' .env

# 6) Стартуем
docker compose up -d --build
docker compose logs -f --tail=100 wp-cli
