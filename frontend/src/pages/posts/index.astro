---
import Container from "@/layouts/Container.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { wpFetch } from "@/lib/wp";

// 15 последних постов
const posts: any[] = await wpFetch(
  `/wp/v2/posts?per_page=15&orderby=date&order=desc&_fields=id,slug,date,link,title,excerpt,acf`
);

const slugOf = (p: any) => p.slug ?? p.link?.split("/").filter(Boolean).pop();
const imgOf  = (p: any) => p?.acf?.seo?.seo_image || "/images/news-placeholder.jpg";
const fmt    = (iso: string) => new Date(iso).toLocaleDateString("ru-RU", { day: "2-digit", month: "long", year: "numeric" });

const [featured, ...rest] = posts;
const highlights = rest.slice(0, 2);
const masonry    = rest.slice(2);
---

<BaseLayout
  title="Новости"
  description="Аренда оборудования для праздников в Гродно — свежие новости и статьи"
>
  <Container big class:list="mt-32 mb-20 space-y-10">
    <!-- Витрина -->
    {featured && (
      <section class="grid gap-6 lg:grid-cols-3">
        <!-- Большая карточка слева -->
        <article class="group relative overflow-hidden rounded-3xl border bg-white lg:col-span-2">
          <a href={`/posts/${slugOf(featured)}`} class="absolute inset-0 z-10" aria-label="Читать новость" />
          <div class="relative aspect-[16/9] h-full">
            <img
              src={imgOf(featured)} alt={featured.title?.rendered || "Новость"}
              class="absolute inset-0 h-full w-full object-cover transition duration-500 group-hover:scale-105"
              loading="lazy" decoding="async"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent" />
          </div>
          <div class="pointer-events-none absolute inset-x-0 bottom-0 z-10
              h-40 md:h-52 bg-gradient-to-t from-black/80 via-black/40 to-transparent"
              aria-hidden="true"
            />
          <div class="absolute inset-x-0 bottom-0 p-6 md:p-8 z-20">
            <time datetime={featured.date} class="mb-2 block text-sm text-white/80">{fmt(featured.date)}</time>
            <h2 class="text-2xl md:text-3xl font-semibold leading-snug text-white">
              <span set:html={featured.title.rendered} />
            </h2>
            <p class="mt-3 hidden max-w-3xl text-white/85 md:block">
              <span set:html={featured.acf.seo?.short_description} />
            </p>
          </div>
        </article>

        <!-- Две компактные карточки справа -->
        <div class="grid gap-6">
          {highlights.map((p) => (
            <article class="group relative overflow-hidden rounded-3xl border bg-white">
              <a href={`/posts/${slugOf(p)}`} class="absolute inset-0 z-10" aria-label="Читать новость" />
              <div class="relative aspect-[16/10]">
                <img
                  src={imgOf(p)} alt={p.title?.rendered || "Новость"}
                  class="absolute inset-0 h-full w-full object-cover transition duration-500 group-hover:scale-105"
                  loading="lazy" decoding="async"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/10 to-transparent" />
              </div>
                        <div class="pointer-events-none absolute inset-x-0 bottom-0 z-10
              h-10 md:h-52 bg-gradient-to-t from-black/80 via-black/40 to-transparent"
              aria-hidden="true"
            />
              <div class="absolute inset-x-0 bottom-0 p-5 z-20">
                <time datetime={p.date} class="mb-1 block text-xs text-white/80">{fmt(p.date)}</time>
                <h3 class="text-lg font-semibold text-white">
                  <span set:html={p.title.rendered} />
                </h3>
              </div>
            </article>
          ))}
        </div>
      </section>
    )}

    <!-- Masonry-лента -->
    <section class="masonry columns-1 gap-6 md:columns-2 lg:columns-3">
      {masonry.map((p) => (
        <article class="mb-6 break-inside-avoid overflow-hidden rounded-3xl border bg-white transition hover:shadow-md">
          <a href={`/posts/${slugOf(p)}`} class="block">
            <div class="relative aspect-[16/10]">
              <img
                src={imgOf(p)} alt={p.title?.rendered || "Новость"}
                class="absolute inset-0 h-full w-full object-cover"
                loading="lazy" decoding="async"
              />
            </div>
            <div class="p-5">
              <time datetime={p.date} class="text-xs text-muted-foreground">{fmt(p.date)}</time>
              <h3 class="mt-1 text-lg font-semibold text-foreground">
                <span set:html={p.title.rendered} />
              </h3>
              <div class="mt-2 line-clamp-3 text-sm text-muted-foreground">
                <span set:html={p.excerpt?.rendered} />
              </div>
              <span class="mt-3 inline-flex items-center text-sm font-medium text-indigo-600">
                Читать далее →
              </span>
            </div>
          </a>
        </article>
      ))}
    </section>

  </Container>
</BaseLayout>
