---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Container from "@/layouts/Container.astro";
import {
  Breadcrumb,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbList,
  BreadcrumbPage,
  BreadcrumbSeparator,
} from "@/components/ui/breadcrumb";
import CatalogCard from "@/components/Catalog/CatalogCard.astro";
import { wpFetch } from "@/lib/wp";

interface Category {
  id: number;
  name: string;
  slug: string;
  description?: string;
  acf?: {
    image?: string;
    seo_title: string;
    seo_image: string;
  };
}

interface WPItem {
  id: number;
  title: {
    rendered: string;
  };
  slug: string;
  menu_order: number;
  acf?: {
    image?: string;
  };
  featured_media?: number;
  featured_media_url?: string;
}

export async function getStaticPaths() {
  try {
    const categories = await wpFetch(`/wp/v2/inv-cat`);
    return categories.map((category: Category) => ({
      params: { slug: category.slug },
      props: { category },
    }));
  } catch (error) {
    console.warn('WordPress API недоступен во время сборки, создаем fallback страницы');
    // Fallback для production сборки
    return [
      {
        params: { slug: 'default' },
        props: { 
          category: {
            id: 1,
            name: 'Каталог',
            slug: 'default',
            description: 'Каталог товаров',
            acf: {
              seo_title: 'Каталог',
              seo_image: ''
            }
          } 
        },
      }
    ];
  }
}

const { category } = Astro.props as { category: Category };
const { slug } = Astro.params;

let items: WPItem[] = [];
try {
  items = await wpFetch(`/wp/v2/goods?inv-cat=${category.id}`);
} catch (error) {
  console.warn('Не удалось получить товары из WordPress API');
  items = [];
}
---

<BaseLayout
  title={`${category.acf?.seo_title} > ${category.name}`}
  description={category.description}
  image={category.acf?.image}
>
  <Container class:list="mt-32 mb-16 bg-zinc-50">
    <Breadcrumb>
      <BreadcrumbList>
        <BreadcrumbItem>
          <BreadcrumbLink href="/catalog">Каталог</BreadcrumbLink>
        </BreadcrumbItem>
        <BreadcrumbSeparator />
        <BreadcrumbItem>
          <BreadcrumbPage>{category.name}</BreadcrumbPage>
        </BreadcrumbItem>
      </BreadcrumbList>
    </Breadcrumb>
    <h1 class="mb-8 text-4xl font-bold" set:html={category.name} />
    {
      category.description && (
        <div
          class="mb-8 prose prose-lg max-w-none"
          set:html={category.description}
        />
      )
    }

    <div
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 [&>*]:first:order-first"
    >
      {items.map((item: WPItem) => <CatalogCard item={item} slug={slug} />)}
    </div>
  </Container>
</BaseLayout>
